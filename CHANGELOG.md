# Changelog

## [1.4] - 2025-05-02

### Added

- **Rewrite Rules with Conditions**:
  - Добавлена поддержка правил перезаписи URL с условиями, таких как проверка существования файлов (`if -f`) или других параметров.
  - Пример правила: `*.html if -f /path/to/file /new/path`.

- **Automatic HTTP to HTTPS Redirection**:
  - Реализован автоматический редирект с HTTP на HTTPS, если для хоста настроен SSL-сертификат.

- **Preservation of Query Parameters**:
  - Добавлена поддержка сохранения параметров запроса (`query string`) при выполнении правил перезаписи URL.

- **Enhanced Plugin System**:
  - Расширен интерфейс плагинов для поддержки более сложной логики обработки запросов.
  - Добавлены примеры плагинов для демонстрации возможностей системы.

- **Support for Razor Pages**:
  - Добавлена специальная поддержка .NET Razor Pages через новую директиву конфигурации `AppType=razorpages`.

- **Improved Error Handling**:
  - Добавлены более информативные сообщения об ошибках для конечных пользователей и администраторов.

- **HTTP/3 Support**:
  - Добавлена поддержка протокола HTTP/3 с использованием QUIC для улучшения производительности и безопасности.
  - HTTP/3 доступен на отдельном порту (по умолчанию `ListenHTTPS + 1`).

- **Improved Error Handling**:
  - Добавлены более информативные сообщения об ошибках для конечных пользователей и администраторов.

### Changed

- **Code Optimization**:
  - Оптимизирована работа с кэшем для уменьшения задержек при обслуживании статических файлов.
  - Улучшена производительность middleware за счет минимизации блокировок.

- **Configuration File Parsing**:
  - Улучшена обработка комментариев и пустых строк в конфигурационном файле.
  - Добавлена поддержка новых директив, таких как `AppType` и `RewriteRule`.

- **Logging Improvements**:
  - Добавлены дополнительные поля в логи для упрощения отладки (например, `host`, `path`, `method`).
  - Улучшено форматирование JSON-логов для совместимости с системами сбора логов.

- **WebSocket Enhancements**:
  - Добавлена возможность отправки широковещательных сообщений всем активным WebSocket-соединениям.

### Fixed

- Исправлена проблема с неиспользуемой переменной `query` в коде обработки rewrite rules.
- Устранена утечка памяти при работе с большими файлами в кэше.
- Исправлена обработка некорректных заголовков CORS.
- Устранены ошибки при запуске Node.js приложений с неправильными путями.

### Removed

- Удалены устаревшие функции для работы с прокси, замененные более эффективными решениями.
- Убраны неиспользуемые зависимости из `go.mod`.

### Security

- Добавлена защита от path traversal атак с использованием строгой валидации путей.
- Улучшена обработка заголовков `Host` для предотвращения атак типа Host Header Injection.
- Настроено использование безопасных значений для заголовков `Content-Type` и `Content-Disposition`.

---

### Пример использования

```bash
# Тестирование rewrite rules
curl -I http://localhost:8080/old-page.html

# Проверка автоматического редиректа HTTP -> HTTPS
curl -I http://localhost:8080/

# Запуск сервера с новыми плагинами
./gubinnet --plugin=myplugin.so
```

### Known Issues

- При использовании сложных rewrite rules возможно снижение производительности. Рекомендуется тестировать правила перед развертыванием в production.
- Если файл `.ini` содержит ошибки в новых директивах (например, `RewriteRule`), сервер может не запуститься. Убедитесь в корректности конфигурации.

## [1.3] - 2025-04-27

### Added

- **Anti-DDoS Protection**:
  - Добавлена защита от DDoS-атак с настраиваемыми параметрами, такими как максимальное количество запросов в секунду (`AntiDDoSMaxRequestsPerSecond`) и длительность блокировки (`AntiDDoSBlockDuration`).
  - Реализован механизм блокировки IP-адресов, превышающих допустимый лимит запросов.

- **WebSocket Support**:
  - Добавлена поддержка WebSocket соединений с возможностью обработки сообщений в реальном времени.
  - Реализован базовый эхо-сервер для тестирования WebSocket.

- **Dynamic Configuration Reload**:
  - Улучшена обработка сигнала `SIGHUP` для перезагрузки конфигурации без перезапуска сервера.

- **Logging Enhancements**:
  - Обновлен формат логов для более удобного анализа (JSON).
  - Добавлены уникальные идентификаторы запросов (`X-Request-ID`) для трассировки.

- **Rate Limiting Improvements**:
  - Добавлена поддержка настройки ограничения скорости запросов для каждого виртуального хоста.

- **Fallback Mechanism for SPA**:
  - Улучшен механизм fallback для Single Page Applications (SPA), позволяющий корректно обслуживать маршруты фронтенда.

### Changed

- **Code Refactoring**:
  - Проведен рефакторинг кода для улучшения читаемости и поддержки.
  - Удалены неиспользуемые импорты и исправлены предупреждения компилятора.

- **Configuration Parsing**:
  - Улучшена обработка ошибок при загрузке конфигурации.
  - Добавлена проверка корректности путей к файлам и директориям.

- **Middleware Optimization**:
  - Оптимизированы middleware для логирования, метрик и восстановления после паники.

### Fixed

- Исправлена работа с путями файлов при использовании разных операционных систем (Windows/Linux).
- Устранены проблемы с лишними запятыми в логах и конфигурационных файлах.
- Исправлена обработка ошибок при загрузке SSL-сертификатов.

### Removed

- Удалены устаревшие комментарии и неиспользуемые переменные.

### Security

- Добавлена дополнительная проверка заголовков запросов для защиты от потенциальных атак.
- Улучшена обработка больших файлов и запросов для предотвращения переполнения памяти.

---

### Пример использования

```bash
# Запуск сервера с защитой от DDoS
./gubinnet

# Тестирование WebSocket
wscat -c ws://localhost:8080/ws

# Проверка rate limiting
ab -n 100 -c 10 http://localhost:8080/
```

### Known Issues

- При высокой нагрузке возможны задержки в обработке запросов, если не настроены оптимальные параметры Anti-DDoS.
- Если файл конфигурации содержит ошибки, сервер может не запуститься. Убедитесь в корректности `.ini` файла перед запуском.

## [1.2] - 2025-04-21

### Added

- **Основная функциональность сервера**:
  - Реализована поддержка HTTP и HTTPS серверов с возможностью динамической загрузки SSL-сертификатов.
  - Добавлена поддержка проксирования запросов к внутренним приложениям (например, .NET и Node.js).
  - Внедрена система виртуальных хостов с возможностью настройки через конфигурационный файл `.ini`.
  - Добавлена поддержка статических файлов и SPA (Single Page Applications) с fallback-механизмом.
  - Реализован механизм ограничения скорости запросов (Rate Limiting) для защиты от злоупотреблений.
  - Добавлена базовая аутентификация (Basic Auth) для защиты ресурсов.
  - Поддержка CORS (Cross-Origin Resource Sharing) с настраиваемыми origin, методами и заголовками.

- **Логирование**:
  - Внедрена система логирования с поддержкой JSON-формата и уровнями логирования (`INFO`, `WARNING`, `ERROR`, `DEBUG`).

- **Метрики**:
  - Интеграция с Prometheus для мониторинга метрик, таких как количество запросов, их длительность и активные соединения.

- **Кэширование**:
  - Реализовано кэширование статических файлов с учетом времени модификации и ETag.

- **Сжатие**:
  - Добавлена поддержка Gzip-сжатия ответов для уменьшения объема передаваемых данных.

- **Загрузка конфигурации**:
  - Автоматическое создание закомментированного файла конфигурации `.ini`, если он отсутствует.
  - Возможность перезагрузки конфигурации без перезапуска сервера (SIGHUP).

- **Health Check**:
  - Добавлен эндпоинт `/health` для проверки работоспособности сервера.

- **Graceful Shutdown**:
  - Реализовано корректное завершение работы сервера с остановкой всех запущенных приложений (.NET, Node.js).

### Changed

- Улучшена обработка ошибок и добавлены middleware для логирования, метрик и восстановления после паники.
- Оптимизирована работа с файловой системой для обслуживания статических файлов.

### Fixed

- Исправлена обработка некорректных URL-путей (например, содержащих `../`).
- Устранены проблемы с определением реального IP-адреса клиента при использовании прокси.

### Removed

- Удалены неиспользуемые зависимости и устаревшие части кода.

### Security

- Добавлена защита от слишком больших запросов с помощью ограничения размера тела запроса (`MaxRequestSize`).
- Настроено использование TLS 1.2 и выше для HTTPS-соединений.

---

### Пример использования

```bash
# Запуск сервера
./gubinnet

# Проверка health check
curl http://localhost:8081/health

# Просмотр метрик Prometheus
curl http://localhost:9090/metrics
```

### Known Issues

- Если файл конфигурации содержит синтаксические ошибки, сервер может не запуститься. Убедитесь в корректности `.ini` файла.